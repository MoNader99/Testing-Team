"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CHROMIUM_WIN = exports.WEBVIEW_BASE = exports.WEBVIEW_WIN = exports.NATIVE_WIN = exports.helpers = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

const NATIVE_WIN = 'NATIVE_APP';
exports.NATIVE_WIN = NATIVE_WIN;
const WEBVIEW_WIN = 'WEBVIEW';
exports.WEBVIEW_WIN = WEBVIEW_WIN;
const WEBVIEW_BASE = `${WEBVIEW_WIN}_`;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
const WEBVIEW_PID_REGEXP = new RegExp(`^${WEBVIEW_BASE}(\\d+)`);
const WEBVIEW_PKG_REGEXP = new RegExp(`^${WEBVIEW_BASE}([^\\d\\s][\\w.]*)`);
const CHROMIUM_WIN = 'CHROMIUM';
exports.CHROMIUM_WIN = CHROMIUM_WIN;
const DEFAULT_WEBVIEW_DEVTOOLS_PORT = 9222;
const DEVTOOLS_SOCKET_PATTERN = /@[\w.]+_devtools_remote_?(\d+)?\b/;
const CROSSWALK_SOCKET_PATTERN = /@([\w.]+)_devtools_remote\b/;
const CHROMIUM_DEVTOOLS_SOCKET = 'chrome_devtools_remote';
const CHROME_PACKAGE_NAME = 'com.android.chrome';
let helpers = {};
exports.helpers = helpers;

async function getPotentialWebviewProcs(adb) {
  const out = await adb.shell(['cat', '/proc/net/unix']);
  const names = [];

  for (const line of out.split('\n')) {
    const [,,, flags,, st,, sockPath] = line.trim().split(/\s+/);

    if (!sockPath) {
      continue;
    }

    if (flags !== '00010000' || st !== '01') {
      continue;
    }

    if (!DEVTOOLS_SOCKET_PATTERN.test(sockPath)) {
      continue;
    }

    names.push(sockPath);
  }

  if (_lodash.default.isEmpty(names)) {
    _logger.default.debug('Found no active devtools sockets. Other sockets are:');

    _logger.default.debug(out);
  } else {
    _logger.default.debug(`Parsed ${names.length} active devtools ${_appiumSupport.util.pluralize('socket', names.length, false)}: ` + JSON.stringify(names));
  }

  return _lodash.default.uniq(names);
}

async function webviewsFromProcs(adb, deviceSocket = null) {
  const socketNames = await getPotentialWebviewProcs(adb);
  const webviews = [];

  for (const socketName of socketNames) {
    if (deviceSocket === CHROMIUM_DEVTOOLS_SOCKET && socketName === `@${deviceSocket}`) {
      webviews.push({
        proc: socketName,
        webview: CHROMIUM_WIN
      });
      continue;
    }

    const socketNameMatch = DEVTOOLS_SOCKET_PATTERN.exec(socketName);

    if (!socketNameMatch) {
      continue;
    }

    const crosswalkMatch = CROSSWALK_SOCKET_PATTERN.exec(socketName);

    if (!socketNameMatch[1] && !crosswalkMatch) {
      continue;
    }

    if (deviceSocket && socketName === `@${deviceSocket}` || !deviceSocket) {
      webviews.push({
        proc: socketName,
        webview: socketNameMatch[1] ? `${WEBVIEW_BASE}${socketNameMatch[1]}` : `${WEBVIEW_BASE}${crosswalkMatch[1]}`
      });
    }
  }

  return webviews;
}

async function webviewHasPages(adb, {
  proc,
  webview
}, webviewDevtoolsPort) {
  const wvPort = webviewDevtoolsPort || DEFAULT_WEBVIEW_DEVTOOLS_PORT;
  const remotePort = proc.replace(/^@/, '');
  const portAlreadyForwarded = (await adb.getForwardList()).map(line => line.split(' ')[1]).reduce((acc, portSpec) => acc || portSpec === `tcp:${wvPort}`, false);

  if (portAlreadyForwarded) {
    _logger.default.info(`Port ${wvPort} was already forwarded`);
  } else {
    await adb.adbExec(['forward', `tcp:${wvPort}`, `localabstract:${remotePort}`]);
  }

  const remoteDebugger = `http://127.0.0.1:${wvPort}/json/list`;

  _logger.default.debug(`Attempting to get list of pages for webview '${webview}' ` + `from the remote debugger at ${remoteDebugger}.`);

  let hasPages = false;

  try {
    const pages = await (0, _requestPromise.default)({
      uri: remoteDebugger,
      json: true
    });

    if (pages.length > 0) {
      hasPages = true;
    }

    _logger.default.info(`Webview '${webview}' has ${_appiumSupport.util.pluralize('page', pages.length, true)}`);
  } catch (e) {
    _logger.default.warn(`Got error when retrieving page list, will assume no pages: ${e}`);
  }

  if (!portAlreadyForwarded) {
    await adb.removePortForward(wvPort);
  }

  return hasPages;
}

helpers.procFromWebview = async function procFromWebview(adb, webview) {
  const pidMatch = WEBVIEW_PID_REGEXP.exec(webview);

  if (!pidMatch) {
    throw new Error(`Could not find PID for webview '${webview}'`);
  }

  const pid = pidMatch[1];

  _logger.default.debug(`${webview} mapped to pid ${pid}`);

  _logger.default.debug(`Getting process name for webview '${webview}'`);

  const pkg = await adb.getNameByPid(pid);

  _logger.default.debug(`Got process name: '${pkg}'`);

  return pkg;
};

helpers.getWebviews = async function getWebviews(adb, {
  androidDeviceSocket = null,
  ensureWebviewsHavePages = null,
  webviewDevtoolsPort = null
} = {}) {
  _logger.default.debug('Getting a list of available webviews');

  let webviewsMapping = await webviewsFromProcs(adb, androidDeviceSocket);

  if (ensureWebviewsHavePages) {
    _logger.default.info('Retrieved potential webviews; will filter out ones with no active pages');

    webviewsMapping = await (0, _asyncbox.asyncfilter)(webviewsMapping, async wp => await webviewHasPages(adb, wp, webviewDevtoolsPort), false);
  } else {
    _logger.default.info('Not checking whether webviews have active pages; use the ' + "'ensureWebviewsHavePages' cap to turn this check on");
  }

  const webviews = webviewsMapping.map(wp => wp.webview);
  const result = [];

  if (androidDeviceSocket) {
    result.push(...webviews);
  } else {
    for (const webviewName of webviews) {
      try {
        const pkgMatch = WEBVIEW_PKG_REGEXP.exec(webviewName);
        const pkg = pkgMatch ? pkgMatch[1] : await helpers.procFromWebview(adb, webviewName);
        result.push(`${WEBVIEW_BASE}${pkg}`);
      } catch (e) {
        _logger.default.warn(e.message);
      }
    }
  }

  _logger.default.debug(`Found ${_appiumSupport.util.pluralize('webview', result.length, true)}: ${JSON.stringify(result)}`);

  return result;
};

helpers.createChromedriverCaps = function createChromedriverCaps(opts, deviceId) {
  var _opts$chromeOptions, _opts$chromeOptions2;

  const caps = {
    chromeOptions: {
      androidPackage: ((_opts$chromeOptions = opts.chromeOptions) === null || _opts$chromeOptions === void 0 ? void 0 : _opts$chromeOptions.androidPackage) || opts.appPackage
    }
  };

  if (_lodash.default.isBoolean(opts.chromeUseRunningApp)) {
    caps.chromeOptions.androidUseRunningApp = opts.chromeUseRunningApp;
  }

  if (opts.chromeAndroidPackage) {
    caps.chromeOptions.androidPackage = opts.chromeAndroidPackage;
  }

  if (opts.chromeAndroidActivity) {
    caps.chromeOptions.androidActivity = opts.chromeAndroidActivity;
  }

  if (opts.chromeAndroidProcess) {
    caps.chromeOptions.androidProcess = opts.chromeAndroidProcess;
  }

  if (_lodash.default.toLower(opts.browserName) === 'chromium-webview') {
    _logger.default.info(`Automatically setting 'androidActivity' capability ` + `to '${opts.appActivity}' for '${opts.browserName}' browser`);

    caps.chromeOptions.androidActivity = opts.appActivity;
  }

  if (opts.pageLoadStrategy) {
    caps.pageLoadStrategy = opts.pageLoadStrategy;
  }

  if (_lodash.default.toLower(caps.chromeOptions.androidPackage) === 'chrome') {
    _logger.default.info(`'androidPackage' Chromedriver capability has been ` + `automatically corrected to '${CHROME_PACKAGE_NAME}'`);

    caps.chromeOptions.androidPackage = CHROME_PACKAGE_NAME;
    delete caps.chromeOptions.androidActivity;
    delete caps.chromeOptions.androidProcess;
  }

  caps.chromeOptions.androidDeviceSerial = deviceId;

  if (opts.loggingPrefs) {
    caps.loggingPrefs = opts.loggingPrefs;
  }

  if (opts.enablePerformanceLogging) {
    _logger.default.warn(`The 'enablePerformanceLogging' cap is deprecated; simply use ` + `the 'loggingPrefs' cap instead, with a 'performance' key set to 'ALL'`);

    const newPref = {
      performance: 'ALL'
    };
    caps.loggingPrefs = caps.loggingPrefs ? Object.assign({}, caps.loggingPrefs, newPref) : newPref;
  }

  if ((_opts$chromeOptions2 = opts.chromeOptions) === null || _opts$chromeOptions2 === void 0 ? void 0 : _opts$chromeOptions2.Arguments) {
    opts.chromeOptions.args = [...(opts.chromeOptions.args || []), ...opts.chromeOptions.Arguments];
    delete opts.chromeOptions.Arguments;
  }

  for (const [opt, val] of _lodash.default.toPairs(opts.chromeOptions)) {
    if (_lodash.default.isUndefined(caps.chromeOptions[opt])) {
      caps.chromeOptions[opt] = val;
    } else {
      _logger.default.info(`The '${opt}' chromeOption (${caps.chromeOptions[opt]}) ` + `won't be applied to Chromedriver capabilities because it has been already assigned before`);
    }
  }

  return caps;
};

var _default = helpers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJ2aWV3LWhlbHBlcnMuanMiXSwibmFtZXMiOlsiTkFUSVZFX1dJTiIsIldFQlZJRVdfV0lOIiwiV0VCVklFV19CQVNFIiwiV0VCVklFV19QSURfUkVHRVhQIiwiUmVnRXhwIiwiV0VCVklFV19QS0dfUkVHRVhQIiwiQ0hST01JVU1fV0lOIiwiREVGQVVMVF9XRUJWSUVXX0RFVlRPT0xTX1BPUlQiLCJERVZUT09MU19TT0NLRVRfUEFUVEVSTiIsIkNST1NTV0FMS19TT0NLRVRfUEFUVEVSTiIsIkNIUk9NSVVNX0RFVlRPT0xTX1NPQ0tFVCIsIkNIUk9NRV9QQUNLQUdFX05BTUUiLCJoZWxwZXJzIiwiZ2V0UG90ZW50aWFsV2Vidmlld1Byb2NzIiwiYWRiIiwib3V0Iiwic2hlbGwiLCJuYW1lcyIsImxpbmUiLCJzcGxpdCIsImZsYWdzIiwic3QiLCJzb2NrUGF0aCIsInRyaW0iLCJ0ZXN0IiwicHVzaCIsIl8iLCJpc0VtcHR5IiwibG9nZ2VyIiwiZGVidWciLCJsZW5ndGgiLCJ1dGlsIiwicGx1cmFsaXplIiwiSlNPTiIsInN0cmluZ2lmeSIsInVuaXEiLCJ3ZWJ2aWV3c0Zyb21Qcm9jcyIsImRldmljZVNvY2tldCIsInNvY2tldE5hbWVzIiwid2Vidmlld3MiLCJzb2NrZXROYW1lIiwicHJvYyIsIndlYnZpZXciLCJzb2NrZXROYW1lTWF0Y2giLCJleGVjIiwiY3Jvc3N3YWxrTWF0Y2giLCJ3ZWJ2aWV3SGFzUGFnZXMiLCJ3ZWJ2aWV3RGV2dG9vbHNQb3J0Iiwid3ZQb3J0IiwicmVtb3RlUG9ydCIsInJlcGxhY2UiLCJwb3J0QWxyZWFkeUZvcndhcmRlZCIsImdldEZvcndhcmRMaXN0IiwibWFwIiwicmVkdWNlIiwiYWNjIiwicG9ydFNwZWMiLCJpbmZvIiwiYWRiRXhlYyIsInJlbW90ZURlYnVnZ2VyIiwiaGFzUGFnZXMiLCJwYWdlcyIsInVyaSIsImpzb24iLCJlIiwid2FybiIsInJlbW92ZVBvcnRGb3J3YXJkIiwicHJvY0Zyb21XZWJ2aWV3IiwicGlkTWF0Y2giLCJFcnJvciIsInBpZCIsInBrZyIsImdldE5hbWVCeVBpZCIsImdldFdlYnZpZXdzIiwiYW5kcm9pZERldmljZVNvY2tldCIsImVuc3VyZVdlYnZpZXdzSGF2ZVBhZ2VzIiwid2Vidmlld3NNYXBwaW5nIiwid3AiLCJyZXN1bHQiLCJ3ZWJ2aWV3TmFtZSIsInBrZ01hdGNoIiwibWVzc2FnZSIsImNyZWF0ZUNocm9tZWRyaXZlckNhcHMiLCJvcHRzIiwiZGV2aWNlSWQiLCJjYXBzIiwiY2hyb21lT3B0aW9ucyIsImFuZHJvaWRQYWNrYWdlIiwiYXBwUGFja2FnZSIsImlzQm9vbGVhbiIsImNocm9tZVVzZVJ1bm5pbmdBcHAiLCJhbmRyb2lkVXNlUnVubmluZ0FwcCIsImNocm9tZUFuZHJvaWRQYWNrYWdlIiwiY2hyb21lQW5kcm9pZEFjdGl2aXR5IiwiYW5kcm9pZEFjdGl2aXR5IiwiY2hyb21lQW5kcm9pZFByb2Nlc3MiLCJhbmRyb2lkUHJvY2VzcyIsInRvTG93ZXIiLCJicm93c2VyTmFtZSIsImFwcEFjdGl2aXR5IiwicGFnZUxvYWRTdHJhdGVneSIsImFuZHJvaWREZXZpY2VTZXJpYWwiLCJsb2dnaW5nUHJlZnMiLCJlbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmciLCJuZXdQcmVmIiwicGVyZm9ybWFuY2UiLCJPYmplY3QiLCJhc3NpZ24iLCJBcmd1bWVudHMiLCJhcmdzIiwib3B0IiwidmFsIiwidG9QYWlycyIsImlzVW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFVBQVUsR0FBRyxZQUFuQjs7QUFDQSxNQUFNQyxXQUFXLEdBQUcsU0FBcEI7O0FBQ0EsTUFBTUMsWUFBWSxHQUFJLEdBQUVELFdBQVksR0FBcEM7O0FBQ0EsTUFBTUUsa0JBQWtCLEdBQUcsSUFBSUMsTUFBSixDQUFZLElBQUdGLFlBQWEsUUFBNUIsQ0FBM0I7QUFDQSxNQUFNRyxrQkFBa0IsR0FBRyxJQUFJRCxNQUFKLENB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TCxDQUFtQndCLEdBQW5CLENBQWQsQ0FBSixFQUE0QztBQUMxQ3pCLE1BQUFBLElBQUksQ0FBQ0MsYUFBTCxDQUFtQndCLEdBQW5CLElBQTBCQyxHQUExQjtBQUNELEtBRkQsTUFFTztBQUNMbkYsc0JBQU82QixJQUFQLENBQWEsUUFBT3FELEdBQUksbUJBQWtCekIsSUFBSSxDQUFDQyxhQUFMLENBQW1Cd0IsR0FBbkIsQ0FBd0IsSUFBdEQsR0FDVCwyRkFESDtBQUVEO0FBQ0Y7O0FBQ0QsU0FBT3pCLElBQVA7QUFDRCxDQWxFRDs7ZUFvRWV6RSxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBhc3luY2ZpbHRlciB9IGZyb20gJ2FzeW5jYm94JztcblxuY29uc3QgTkFUSVZFX1dJTiA9ICdOQVRJVkVfQVBQJztcbmNvbnN0IFdFQlZJRVdfV0lOID0gJ1dFQlZJRVcnO1xuY29uc3QgV0VCVklFV19CQVNFID0gYCR7V0VCVklFV19XSU59X2A7XG5jb25zdCBXRUJWSUVXX1BJRF9SRUdFWFAgPSBuZXcgUmVnRXhwKGBeJHtXRUJWSUVXX0JBU0V9KFxcXFxkKylgKTtcbmNvbnN0IFdFQlZJRVdfUEtHX1JFR0VYUCA9IG5ldyBSZWdFeHAoYF4ke1dFQlZJRVdfQkFTRX0oW15cXFxcZFxcXFxzXVtcXFxcdy5dKilgKTtcbmNvbnN0IENIUk9NSVVNX1dJTiA9ICdDSFJPTUlVTSc7XG5jb25zdCBERUZBVUxUX1dFQlZJRVdfREVWVE9PTFNfUE9SVCA9IDkyMjI7XG5jb25zdCBERVZUT09MU19TT0NLRVRfUEFUVEVSTiA9IC9AW1xcdy5dK19kZXZ0b29sc19yZW1vdGVfPyhcXGQrKT9cXGIvO1xuY29uc3QgQ1JPU1NXQUxLX1NPQ0tFVF9QQVRURVJOID0gL0AoW1xcdy5dKylfZGV2dG9vbHNfcmVtb3RlXFxiLztcbmNvbnN0IENIUk9NSVVNX0RFVlRPT0xTX1NPQ0tFVCA9ICdjaHJvbWVfZGV2dG9vbHNfcmVtb3RlJztcbmNvbnN0IENIUk9NRV9QQUNLQUdFX05BTUUgPSAnY29tLmFuZHJvaWQuY2hyb21lJztcblxuXG5sZXQgaGVscGVycyA9IHt9O1xuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gZ2V0cyBhIGxpc3Qgb2YgYW5kcm9pZCBzeXN0ZW0gcHJvY2Vzc2VzIGFuZCByZXR1cm5zIG9uZXNcbiAqIHRoYXQgbG9vayBsaWtlIHdlYnZpZXdzXG4gKiBTZWUgaHR0cHM6Ly9jcy5jaHJvbWl1bS5vcmcvY2hyb21pdW0vc3JjL2Nocm9tZS9icm93c2VyL2RldnRvb2xzL2RldmljZS9hbmRyb2lkX2RldmljZV9pbmZvX3F1ZXJ5LmNjXG4gKiBmb3IgbW9yZSBkZXRhaWxzXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IGFkYiAtIGFuIEFEQiBpbnN0YW5jZVxuICpcbiAqIEByZXR1cm4ge0FycmF5LjxzdHJpbmc+fSAtIGEgbGlzdCBvZiBtYXRjaGluZyB3ZWJ2aWV3IHNvY2tldCBuYW1lcyAoaW5jbHVkaW5nIHRoZSBsZWFkaW5nICdAJylcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0UG90ZW50aWFsV2Vidmlld1Byb2NzIChhZGIpIHtcbiAgY29uc3Qgb3V0ID0gYXdhaXQgYWRiLnNoZWxsKFsnY2F0JywgJy9wcm9jL25ldC91bml4J10pO1xuICBjb25zdCBuYW1lcyA9IFtdO1xuICBmb3IgKGNvbnN0IGxpbmUgb2Ygb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgIC8vIE51bSBSZWZDb3VudCBQcm90b2NvbCBGbGFncyBUeXBlIFN0IElub2RlIFBhdGhcbiAgICBjb25zdCBbLCwsIGZsYWdzLCwgc3QsLCBzb2NrUGF0aF0gPSBsaW5lLnRyaW0oKS5zcGxpdCgvXFxzKy8pO1xuICAgIGlmICghc29ja1BhdGgpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBpZiAoZmxhZ3MgIT09ICcwMDAxMDAwMCcgfHwgc3QgIT09ICcwMScpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBpZiAoIURFVlRPT0xTX1NPQ0tFVF9QQVRURVJOLnRlc3Qoc29ja1BhdGgpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBuYW1lcy5wdXNoKHNvY2tQYXRoKTtcbiAgfVxuICBpZiAoXy5pc0VtcHR5KG5hbWVzKSkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRm91bmQgbm8gYWN0aXZlIGRldnRvb2xzIHNvY2tldHMuIE90aGVyIHNvY2tldHMgYXJlOicpO1xuICAgIGxvZ2dlci5kZWJ1ZyhvdXQpO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZyhgUGFyc2VkICR7bmFtZXMubGVuZ3RofSBhY3RpdmUgZGV2dG9vbHMgJHt1dGlsLnBsdXJhbGl6ZSgnc29ja2V0JywgbmFtZXMubGVuZ3RoLCBmYWxzZSl9OiBgICtcbiAgICAgIEpTT04uc3RyaW5naWZ5KG5hbWVzKSk7XG4gIH1cbiAgLy8gc29tZXRpbWVzIHRoZSB3ZWJ2aWV3IHByb2Nlc3Mgc2hvd3MgdXAgbXVsdGlwbGUgdGltZXMgcGVyIGFwcFxuICByZXR1cm4gXy51bmlxKG5hbWVzKTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBXZWJ2aWV3UHJvY1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHByb2MgLSBUaGUgd2VidmlldyBwcm9jZXNzIG5hbWUgKGFzIHJldHVybmVkIGJ5XG4gKiBnZXRQb3RlbnRpYWxXZWJ2aWV3UHJvY3NcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB3ZWJ2aWV3IC0gVGhlIGFjdHVhbCB3ZWJ2aWV3IGNvbnRleHQgbmFtZVxuICovXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gcmV0cmlldmVzIGEgbGlzdCBvZiBzeXN0ZW0gcHJvY2Vzc2VzIHRoYXQgbG9vayBsaWtlIHdlYnZpZXdzLFxuICogYW5kIHJldHVybnMgdGhlbSBhbG9uZyB3aXRoIHRoZSB3ZWJ2aWV3IGNvbnRleHQgbmFtZSBhcHByb3ByaWF0ZSBmb3IgaXQuXG4gKiBJZiB3ZSBwYXNzIGluIGEgZGV2aWNlU29ja2V0LCB3ZSBvbmx5IGF0dGVtcHQgdG8gZmluZCB3ZWJ2aWV3cyB3aGljaCBtYXRjaFxuICogdGhhdCBzb2NrZXQgbmFtZSAodGhpcyBpcyBmb3IgYXBwcyB3aGljaCBlbWJlZCBDaHJvbWl1bSwgd2hpY2ggaXNuJ3QgdGhlXG4gKiBzYW1lIGFzIGNocm9tZS1iYWNrZWQgd2Vidmlld3MpLlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBhZGIgLSBhbiBBREIgaW5zdGFuY2VcbiAqIEBwYXJhbSB7P3N0cmluZ30gZGV2aWNlU29ja2V0IC0gdGhlIGV4cGxpY3RseS1uYW1lZCBkZXZpY2Ugc29ja2V0IHRvIHVzZVxuICpcbiAqIEByZXR1cm4ge0FycmF5LjxXZWJ2aWV3UHJvYz59XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHdlYnZpZXdzRnJvbVByb2NzIChhZGIsIGRldmljZVNvY2tldCA9IG51bGwpIHtcbiAgY29uc3Qgc29ja2V0TmFtZXMgPSBhd2FpdCBnZXRQb3RlbnRpYWxXZWJ2aWV3UHJvY3MoYWRiKTtcbiAgY29uc3Qgd2Vidmlld3MgPSBbXTtcbiAgZm9yIChjb25zdCBzb2NrZXROYW1lIG9mIHNvY2tldE5hbWVzKSB7XG4gICAgaWYgKGRldmljZVNvY2tldCA9PT0gQ0hST01JVU1fREVWVE9PTFNfU09DS0VUICYmIHNvY2tldE5hbWUgPT09IGBAJHtkZXZpY2VTb2NrZXR9YCkge1xuICAgICAgd2Vidmlld3MucHVzaCh7XG4gICAgICAgIHByb2M6IHNvY2tldE5hbWUsXG4gICAgICAgIHdlYnZpZXc6IENIUk9NSVVNX1dJTixcbiAgICAgIH0pO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29uc3Qgc29ja2V0TmFtZU1hdGNoID0gREVWVE9PTFNfU09DS0VUX1BBVFRFUk4uZXhlYyhzb2NrZXROYW1lKTtcbiAgICBpZiAoIXNvY2tldE5hbWVNYXRjaCkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGNvbnN0IGNyb3Nzd2Fsa01hdGNoID0gQ1JPU1NXQUxLX1NPQ0tFVF9QQVRURVJOLmV4ZWMoc29ja2V0TmFtZSk7XG4gICAgaWYgKCFzb2NrZXROYW1lTWF0Y2hbMV0gJiYgIWNyb3Nzd2Fsa01hdGNoKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoZGV2aWNlU29ja2V0ICYmIHNvY2tldE5hbWUgPT09IGBAJHtkZXZpY2VTb2NrZXR9YCB8fCAhZGV2aWNlU29ja2V0KSB7XG4gICAgICB3ZWJ2aWV3cy5wdXNoKHtcbiAgICAgICAgcHJvYzogc29ja2V0TmFtZSxcbiAgICAgICAgd2Vidmlldzogc29ja2V0TmFtZU1hdGNoWzFdXG4gICAgICAgICAgPyBgJHtXRUJWSUVXX0JBU0V9JHtzb2NrZXROYW1lTWF0Y2hbMV19YFxuICAgICAgICAgIDogYCR7V0VCVklFV19CQVNFfSR7Y3Jvc3N3YWxrTWF0Y2hbMV19YCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gd2Vidmlld3M7XG59XG5cbi8qKlxuICogR2l2ZW4gYSAnd2Vidmlldy1wcm9jJyBvYmplY3QgcmVzdWx0aW5nIGZyb20gYSBjYWxsIHRvIHdlYnZpZXdzRnJvbVByb2NzLFxuICogY2hlY2sgd2hldGhlciB3ZSBjYW4gZGV0ZWN0IGFueSBhY3RpdmUgcGFnZXMgY29ycmVzcG9uZGluZyB0byB0aGF0IHdlYnZpZXcuXG4gKiBUaGlzIGlzIHVzZWQgYnkgZ2V0V2Vidmlld3MgdG8gZmlsdGVyIG91dCBhbnkgd2Vidmlldy1sb29raW5nIHByb2Nlc3Nlc1xuICogd2hpY2ggaGF2ZSBhIHJlbW90ZSBkZWJ1ZyBwb3J0IG9wZW4gYnV0IHdoaWNoIGFyZW4ndCBhY3R1YWxseSBydW5uaW5nIGFueVxuICogcGFnZXMsIGJlY2F1c2Ugc3VjaCBwcm9jZXNzZXMgY2FuJ3QgYmUgYXV0b21hdGVkIGJ5IGNocm9tZWRyaXZlciBhbnl3YXkuXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IGFkYiAtIGFuIEFEQiBpbnN0YW5jZVxuICogQHBhcmFtIHtXZWJ2aWV3UHJvY30gd3AgLSB0aGUgd2VidmlldyB0byBjaGVja1xuICogQHBhcmFtIHtudW1iZXJ9IHdlYnZpZXdEZXZ0b29sc1BvcnQgLSB0aGUgbG9jYWwgcG9ydCB0byB1c2UgZm9yIHRoZSBjaGVja1xuICpcbiAqIEByZXR1cm4ge2Jvb2xlYW59IC0gd2hldGhlciBvciBub3QgdGhlIHdlYnZpZXcgaGFzIHBhZ2VzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHdlYnZpZXdIYXNQYWdlcyAoYWRiLCB7cHJvYywgd2Vidmlld30sIHdlYnZpZXdEZXZ0b29sc1BvcnQpIHtcbiAgY29uc3Qgd3ZQb3J0ID0gd2Vidmlld0RldnRvb2xzUG9ydCB8fCBERUZBVUxUX1dFQlZJRVdfREVWVE9PTFNfUE9SVDtcblxuICAvLyBwcm9jIG5hbWVzIGNvbWUgd2l0aCAnQCcsIGJ1dCB0aGlzIHNob3VsZCBub3QgYmUgYSBwYXJ0IG9mIHRoZSBhYnN0cmFjdFxuICAvLyByZW1vdGUgcG9ydCwgc28gcmVtb3ZlIGl0XG4gIGNvbnN0IHJlbW90ZVBvcnQgPSBwcm9jLnJlcGxhY2UoL15ALywgJycpO1xuXG4gIC8vIHdlIGRvbid0IHdhbnQgdG8gbWVzcyB3aXRoIHRoaW5ncyBpZiBvdXIgd3ZQb3J0IGlzIGFscmVhZHkgZm9yd2FyZGVkLFxuICAvLyBzaW5jZSB3aG8ga25vd3Mgd2hhdCBpcyBjdXJyZW50bHkgZ29pbmcgb24gdGhlcmUuIFNvIGRldGVybWluZSBpZiBpdCBpc1xuICAvLyBhbHJlYWR5IGZvcndhcmRlZCwgYW5kIGp1c3Qgc2hvcnQtY2lyY3VpdCB0aGlzIHdob2xlIG1ldGhvZCBpZiBzby5cbiAgY29uc3QgcG9ydEFscmVhZHlGb3J3YXJkZWQgPSAoYXdhaXQgYWRiLmdldEZvcndhcmRMaXN0KCkpXG4gICAgLm1hcCgobGluZSkgPT4gbGluZS5zcGxpdCgnICcpWzFdKSAvLyB0aGUgbG9jYWwgcG9ydCBpcyB0aGUgc2Vjb25kIGZpZWxkIGluIHRoZSBsaW5lXG4gICAgLnJlZHVjZSgoYWNjLCBwb3J0U3BlYykgPT4gYWNjIHx8IHBvcnRTcGVjID09PSBgdGNwOiR7d3ZQb3J0fWAsIGZhbHNlKTtcbiAgaWYgKHBvcnRBbHJlYWR5Rm9yd2FyZGVkKSB7XG4gICAgbG9nZ2VyLmluZm8oYFBvcnQgJHt3dlBvcnR9IHdhcyBhbHJlYWR5IGZvcndhcmRlZGApO1xuICB9IGVsc2Uge1xuICAgIC8vIGZvcndhcmQgdGhlIHNwZWNpZmllZCBsb2NhbCBwb3J0IHRvIHRoZSByZW1vdGUgZGVidWdnZXIgcG9ydCBvbiB0aGUgZGV2aWNlXG4gICAgYXdhaXQgYWRiLmFkYkV4ZWMoWydmb3J3YXJkJywgYHRjcDoke3d2UG9ydH1gLCBgbG9jYWxhYnN0cmFjdDoke3JlbW90ZVBvcnR9YF0pO1xuICB9XG5cbiAgY29uc3QgcmVtb3RlRGVidWdnZXIgPSBgaHR0cDovLzEyNy4wLjAuMToke3d2UG9ydH0vanNvbi9saXN0YDtcbiAgbG9nZ2VyLmRlYnVnKGBBdHRlbXB0aW5nIHRvIGdldCBsaXN0IG9mIHBhZ2VzIGZvciB3ZWJ2aWV3ICcke3dlYnZpZXd9JyBgICtcbiAgICBgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGF0ICR7cmVtb3RlRGVidWdnZXJ9LmApO1xuICBsZXQgaGFzUGFnZXMgPSBmYWxzZTtcbiAgdHJ5IHtcbiAgICAvLyB0YWtlIGFkdmFudGFnZSBvZiB0aGUgY2hyb21lIHJlbW90ZSBkZWJ1Z2dlciBSRVNUIEFQSSBqdXN0IHRvIGdldFxuICAgIC8vIGEgbGlzdCBvZiBwYWdlc1xuICAgIGNvbnN0IHBhZ2VzID0gYXdhaXQgcmVxdWVzdCh7XG4gICAgICB1cmk6IHJlbW90ZURlYnVnZ2VyLFxuICAgICAganNvbjogdHJ1ZVxuICAgIH0pO1xuICAgIGlmIChwYWdlcy5sZW5ndGggPiAwKSB7XG4gICAgICBoYXNQYWdlcyA9IHRydWU7XG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKGBXZWJ2aWV3ICcke3dlYnZpZXd9JyBoYXMgJHt1dGlsLnBsdXJhbGl6ZSgncGFnZScsIHBhZ2VzLmxlbmd0aCwgdHJ1ZSl9YCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIud2FybihgR290IGVycm9yIHdoZW4gcmV0cmlldmluZyBwYWdlIGxpc3QsIHdpbGwgYXNzdW1lIG5vIHBhZ2VzOiAke2V9YCk7XG4gIH1cbiAgaWYgKCFwb3J0QWxyZWFkeUZvcndhcmRlZCkge1xuICAgIGF3YWl0IGFkYi5yZW1vdmVQb3J0Rm9yd2FyZCh3dlBvcnQpOyAvLyBtYWtlIHN1cmUgd2UgY2xlYW4gdXBcbiAgfVxuICByZXR1cm4gaGFzUGFnZXM7XG59XG5cbi8qKlxuICogVGFrZSBhIHdlYnZpZXcgbmFtZSBsaWtlIFdFQlZJRVdfNDI5NiBhbmQgdXNlICdhZGIgc2hlbGwgcHMnIHRvIGZpZ3VyZSBvdXRcbiAqIHdoaWNoIGFwcCBwYWNrYWdlIGlzIGFzc29jaWF0ZWQgd2l0aCB0aGF0IHdlYnZpZXcuIE9uZSBvZiB0aGUgcmVhc29ucyB3ZVxuICogd2FudCB0byBkbyB0aGlzIGlzIHRvIG1ha2Ugc3VyZSB3ZSdyZSBsaXN0aW5nIHdlYnZpZXdzIGZvciB0aGUgYWN0dWFsIEFVVCxcbiAqIG5vdCBzb21lIG90aGVyIHJ1bm5pbmcgYXBwXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IGFkYiAtIGFuIEFEQiBpbnN0YW5jZVxuICogQHBhcmFtIHtzdHJpbmd9IHdlYnZpZXcgLSBhIHdlYnZpZXcgcHJvY2VzcyBuYW1lXG4gKlxuICogQHJldHVybnMge3N0cmluZ30gLSB0aGUgcGFja2FnZSBuYW1lIG9mIHRoZSBhcHAgcnVubmluZyB0aGUgd2Vidmlld1xuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUgcmV0cmlldmluZyB0aGUgcHJvY2VzcyBuYW1lXG4gKi9cbmhlbHBlcnMucHJvY0Zyb21XZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gcHJvY0Zyb21XZWJ2aWV3IChhZGIsIHdlYnZpZXcpIHtcbiAgY29uc3QgcGlkTWF0Y2ggPSBXRUJWSUVXX1BJRF9SRUdFWFAuZXhlYyh3ZWJ2aWV3KTtcbiAgaWYgKCFwaWRNYXRjaCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgUElEIGZvciB3ZWJ2aWV3ICcke3dlYnZpZXd9J2ApO1xuICB9XG5cbiAgY29uc3QgcGlkID0gcGlkTWF0Y2hbMV07XG4gIGxvZ2dlci5kZWJ1ZyhgJHt3ZWJ2aWV3fSBtYXBwZWQgdG8gcGlkICR7cGlkfWApO1xuICBsb2dnZXIuZGVidWcoYEdldHRpbmcgcHJvY2VzcyBuYW1lIGZvciB3ZWJ2aWV3ICcke3dlYnZpZXd9J2ApO1xuICBjb25zdCBwa2cgPSBhd2FpdCBhZGIuZ2V0TmFtZUJ5UGlkKHBpZCk7XG4gIGxvZ2dlci5kZWJ1ZyhgR290IHByb2Nlc3MgbmFtZTogJyR7cGtnfSdgKTtcbiAgcmV0dXJuIHBrZztcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gR2V0V2Vidmlld3NPcHRzXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYW5kcm9pZERldmljZVNvY2tldCAtIGRldmljZSBzb2NrZXQgbmFtZVxuICogQHByb3BlcnR5IHtib29sZWFufSBlbnN1cmVXZWJ2aWV3c0hhdmVQYWdlcyAtIHdoZXRoZXIgdG8gY2hlY2sgZm9yIHdlYnZpZXdcbiAqIHBhZ2UgcHJlc2VuY2VcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3ZWJ2aWV3RGV2dG9vbHNQb3J0IC0gcG9ydCB0byB1c2UgZm9yIHdlYnZpZXcgcGFnZVxuICogcHJlc2VuY2UgY2hlY2sgKGlmIG5vdCB0aGUgZGVmYXVsdCBvZiA5MjIyKS5cbiAqL1xuLyoqXG4gKiBHZXQgYSBsaXN0IG9mIGF2YWlsYWJsZSB3ZWJ2aWV3cyBieSBpbnRyb3NwZWN0aW5nIHByb2Nlc3NlcyB3aXRoIGFkYiwgd2hlcmVcbiAqIHdlYnZpZXdzIGFyZSBsaXN0ZWQuIEl0J3MgcG9zc2libGUgdG8gcGFzcyBpbiBhICdkZXZpY2VTb2NrZXQnIGFyZywgd2hpY2hcbiAqIGxpbWl0cyB0aGUgd2VidmlldyBwb3NzaWJpbGl0aWVzIHRvIHRoZSBvbmUgcnVubmluZyBvbiB0aGUgQ2hyb21pdW0gZGV2dG9vbHNcbiAqIHNvY2tldCB3ZSdyZSBpbnRlcmVzdGVkIGluIChzZWUgbm90ZSBvbiB3ZWJ2aWV3c0Zyb21Qcm9jcykuIFdlIGNhbiBhbHNvXG4gKiBkaXJlY3QgdGhpcyBtZXRob2QgdG8gdmVyaWZ5IHdoZXRoZXIgYSBwYXJ0aWN1bGFyIHdlYnZpZXcgcHJvY2VzcyBhY3R1YWxseVxuICogaGFzIGFueSBwYWdlcyAoaWYgYSBwcm9jZXNzIGV4aXN0cyBidXQgbm8gcGFnZXMgYXJlIGZvdW5kLCBDaHJvbWVkcml2ZXIgd2lsbFxuICogbm90IGFjdHVhbGx5IGJlIGFibGUgdG8gY29ubmVjdCB0byBpdCwgc28gdGhpcyBzZXJ2ZXMgYXMgYSBndWFyZCBmb3IgdGhhdFxuICogc3RyYW5nZSBmYWlsdXJlIG1vZGUpLiBUaGUgc3RyYXRlZ3kgZm9yIGNoZWNraW5nIHdoZXRoZXIgYW55IHBhZ2VzIGFyZVxuICogYWN0aXZlIGludm9sdmVzIHNlbmRpbmcgYSByZXF1ZXN0IHRvIHRoZSByZW1vdGUgZGVidWcgc2VydmVyIG9uIHRoZSBkZXZpY2UsXG4gKiBoZW5jZSBpdCBpcyBhbHNvIHBvc3NpYmxlIHRvIHNwZWNpZnkgdGhlIHBvcnQgb24gdGhlIGhvc3QgbWFjaGluZSB3aGljaFxuICogc2hvdWxkIGJlIHVzZWQgZm9yIHRoaXMgY29tbXVuaWNhdGlvbi5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gYWRiIC0gYW4gQURCIGluc3RhbmNlXG4gKiBAcGFyYW0ge0dldFdlYnZpZXdPcHRzfSBvcHRzXG4gKlxuICogQHJldHVybiB7QXJyYXkuPHN0cmluZz59IC0gYSBsaXN0IG9mIHdlYnZpZXcgbmFtZXNcbiAqL1xuaGVscGVycy5nZXRXZWJ2aWV3cyA9IGFzeW5jIGZ1bmN0aW9uIGdldFdlYnZpZXdzIChhZGIsIHtcbiAgYW5kcm9pZERldmljZVNvY2tldCA9IG51bGwsXG4gIGVuc3VyZVdlYnZpZXdzSGF2ZVBhZ2VzID0gbnVsbCxcbiAgd2Vidmlld0RldnRvb2xzUG9ydCA9IG51bGxcbn0gPSB7fSkge1xuICBsb2dnZXIuZGVidWcoJ0dldHRpbmcgYSBsaXN0IG9mIGF2YWlsYWJsZSB3ZWJ2aWV3cycpO1xuICBsZXQgd2Vidmlld3NNYXBwaW5nID0gYXdhaXQgd2Vidmlld3NGcm9tUHJvY3MoYWRiLCBhbmRyb2lkRGV2aWNlU29ja2V0KTtcbiAgaWYgKGVuc3VyZVdlYnZpZXdzSGF2ZVBhZ2VzKSB7XG4gICAgbG9nZ2VyLmluZm8oJ1JldHJpZXZlZCBwb3RlbnRpYWwgd2Vidmlld3M7IHdpbGwgZmlsdGVyIG91dCBvbmVzIHdpdGggbm8gYWN0aXZlIHBhZ2VzJyk7XG4gICAgd2Vidmlld3NNYXBwaW5nID0gYXdhaXQgYXN5bmNmaWx0ZXIod2Vidmlld3NNYXBwaW5nLFxuICAgICAgYXN5bmMgKHdwKSA9PiBhd2FpdCB3ZWJ2aWV3SGFzUGFnZXMoYWRiLCB3cCwgd2Vidmlld0RldnRvb2xzUG9ydCksXG4gICAgICBmYWxzZSAvKmVuc3VyZSBzZXJpYWwgb3BlcmF0aW9uKi8pO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5pbmZvKCdOb3QgY2hlY2tpbmcgd2hldGhlciB3ZWJ2aWV3cyBoYXZlIGFjdGl2ZSBwYWdlczsgdXNlIHRoZSAnICtcbiAgICAgICAgICAgICAgICBcIidlbnN1cmVXZWJ2aWV3c0hhdmVQYWdlcycgY2FwIHRvIHR1cm4gdGhpcyBjaGVjayBvblwiKTtcbiAgfVxuXG4gIC8vIHdlYnZpZXdQcm9jcyBjb250YWlucyBwcm9jcywgd2hpY2ggd2Ugb25seSBjYXJlIGFib3V0IGZvciBlbnN1cmluZ1xuICAvLyBwcmVzZW5jZSBvZiBwYWdlcyBhYm92ZSwgc28gd2UgY2FuIG5vdyBkaXNjYXJkIHRoZW0gYW5kIHJlbHkgb24ganVzdCB0aGVcbiAgLy8gd2VidmlldyBuYW1lc1xuICBjb25zdCB3ZWJ2aWV3cyA9IHdlYnZpZXdzTWFwcGluZy5tYXAoKHdwKSA9PiB3cC53ZWJ2aWV3KTtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGlmIChhbmRyb2lkRGV2aWNlU29ja2V0KSB7XG4gICAgcmVzdWx0LnB1c2goLi4ud2Vidmlld3MpO1xuICB9IGVsc2Uge1xuICAgIGZvciAoY29uc3Qgd2Vidmlld05hbWUgb2Ygd2Vidmlld3MpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIHdlYiB2aWV3IG5hbWUgY291bGQgZWl0aGVyIGJlIHN1ZmZpeGVkIHdpdGggUElEIG9yIHRoZSBwYWNrYWdlIG5hbWVcbiAgICAgICAgLy8gcGFja2FnZSBuYW1lcyBjb3VsZCBub3Qgc3RhcnQgd2l0aCBhIGRpZ2l0XG4gICAgICAgIGNvbnN0IHBrZ01hdGNoID0gV0VCVklFV19QS0dfUkVHRVhQLmV4ZWMod2Vidmlld05hbWUpO1xuICAgICAgICBjb25zdCBwa2cgPSBwa2dNYXRjaCA/IHBrZ01hdGNoWzFdIDogYXdhaXQgaGVscGVycy5wcm9jRnJvbVdlYnZpZXcoYWRiLCB3ZWJ2aWV3TmFtZSk7XG4gICAgICAgIHJlc3VsdC5wdXNoKGAke1dFQlZJRVdfQkFTRX0ke3BrZ31gKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oZS5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgbG9nZ2VyLmRlYnVnKGBGb3VuZCAke3V0aWwucGx1cmFsaXplKCd3ZWJ2aWV3JywgcmVzdWx0Lmxlbmd0aCwgdHJ1ZSl9OiAke0pTT04uc3RyaW5naWZ5KHJlc3VsdCl9YCk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG4vKipcbiAqIENyZWF0ZSBDaHJvbWUgZHJpdmVyIGNhcGFiaWxpdGllcyBiYXNlZCBvbiB0aGUgcHJvdmlkZWRcbiAqIEFwcGl1bSBjYXBhYmlsaXRpZXNcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyBVc2VyLXByb3ZpZGVkIGNhcGFiaWxpdGllcyBvYmplY3RcbiAqIEBwYXJhbSB7c3RyaW5nfSBkZXZpY2VJZCBUaGUgaWRlbnRpZmllciBvZiB0aGUgQW5kcm9pZCBkZXZpY2UgdW5kZXIgdGVzdFxuICogQHJldHVybnMge09iamVjdH0gVGhlIGNhcGFiaWxpdGllcyBvYmplY3QuXG4gKiBTZWUgaHR0cHM6Ly9jaHJvbWVkcml2ZXIuY2hyb21pdW0ub3JnL2NhcGFiaWxpdGllcyBmb3IgbW9yZSBkZXRhaWxzLlxuICovXG5oZWxwZXJzLmNyZWF0ZUNocm9tZWRyaXZlckNhcHMgPSBmdW5jdGlvbiBjcmVhdGVDaHJvbWVkcml2ZXJDYXBzIChvcHRzLCBkZXZpY2VJZCkge1xuICBjb25zdCBjYXBzID0ge1xuICAgIGNocm9tZU9wdGlvbnM6IHtcbiAgICAgIGFuZHJvaWRQYWNrYWdlOiBvcHRzLmNocm9tZU9wdGlvbnM/LmFuZHJvaWRQYWNrYWdlIHx8IG9wdHMuYXBwUGFja2FnZSxcbiAgICB9XG4gIH07XG4gIGlmIChfLmlzQm9vbGVhbihvcHRzLmNocm9tZVVzZVJ1bm5pbmdBcHApKSB7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRVc2VSdW5uaW5nQXBwID0gb3B0cy5jaHJvbWVVc2VSdW5uaW5nQXBwO1xuICB9XG4gIGlmIChvcHRzLmNocm9tZUFuZHJvaWRQYWNrYWdlKSB7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRQYWNrYWdlID0gb3B0cy5jaHJvbWVBbmRyb2lkUGFja2FnZTtcbiAgfVxuICBpZiAob3B0cy5jaHJvbWVBbmRyb2lkQWN0aXZpdHkpIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZEFjdGl2aXR5ID0gb3B0cy5jaHJvbWVBbmRyb2lkQWN0aXZpdHk7XG4gIH1cbiAgaWYgKG9wdHMuY2hyb21lQW5kcm9pZFByb2Nlc3MpIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZFByb2Nlc3MgPSBvcHRzLmNocm9tZUFuZHJvaWRQcm9jZXNzO1xuICB9XG4gIGlmIChfLnRvTG93ZXIob3B0cy5icm93c2VyTmFtZSkgPT09ICdjaHJvbWl1bS13ZWJ2aWV3Jykge1xuICAgIGxvZ2dlci5pbmZvKGBBdXRvbWF0aWNhbGx5IHNldHRpbmcgJ2FuZHJvaWRBY3Rpdml0eScgY2FwYWJpbGl0eSBgICtcbiAgICAgIGB0byAnJHtvcHRzLmFwcEFjdGl2aXR5fScgZm9yICcke29wdHMuYnJvd3Nlck5hbWV9JyBicm93c2VyYCk7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRBY3Rpdml0eSA9IG9wdHMuYXBwQWN0aXZpdHk7XG4gIH1cbiAgaWYgKG9wdHMucGFnZUxvYWRTdHJhdGVneSkge1xuICAgIGNhcHMucGFnZUxvYWRTdHJhdGVneSA9IG9wdHMucGFnZUxvYWRTdHJhdGVneTtcbiAgfVxuICBpZiAoXy50b0xvd2VyKGNhcHMuY2hyb21lT3B0aW9ucy5hbmRyb2lkUGFja2FnZSkgPT09ICdjaHJvbWUnKSB7XG4gICAgLy8gaWYgd2UgaGF2ZSBleHRyYWN0ZWQgcGFja2FnZSBmcm9tIGNvbnRleHQgbmFtZSwgaXQgY291bGQgY29tZSBpbiBhcyBiYXJlXG4gICAgLy8gXCJjaHJvbWVcIiwgYW5kIHNvIHdlIHNob3VsZCBtYWtlIHN1cmUgdGhlIGRldGFpbHMgYXJlIGNvcnJlY3QsIGluY2x1ZGluZ1xuICAgIC8vIG5vdCB1c2luZyBhbiBhY3Rpdml0eSBvciBwcm9jZXNzIGlkXG4gICAgbG9nZ2VyLmluZm8oYCdhbmRyb2lkUGFja2FnZScgQ2hyb21lZHJpdmVyIGNhcGFiaWxpdHkgaGFzIGJlZW4gYCArXG4gICAgICBgYXV0b21hdGljYWxseSBjb3JyZWN0ZWQgdG8gJyR7Q0hST01FX1BBQ0tBR0VfTkFNRX0nYCk7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRQYWNrYWdlID0gQ0hST01FX1BBQ0tBR0VfTkFNRTtcbiAgICBkZWxldGUgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRBY3Rpdml0eTtcbiAgICBkZWxldGUgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRQcm9jZXNzO1xuICB9XG4gIC8vIGFkZCBkZXZpY2UgaWQgZnJvbSBhZGJcbiAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWREZXZpY2VTZXJpYWwgPSBkZXZpY2VJZDtcblxuICBpZiAob3B0cy5sb2dnaW5nUHJlZnMpIHtcbiAgICBjYXBzLmxvZ2dpbmdQcmVmcyA9IG9wdHMubG9nZ2luZ1ByZWZzO1xuICB9XG4gIGlmIChvcHRzLmVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZykge1xuICAgIGxvZ2dlci53YXJuKGBUaGUgJ2VuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZycgY2FwIGlzIGRlcHJlY2F0ZWQ7IHNpbXBseSB1c2UgYCArXG4gICAgICBgdGhlICdsb2dnaW5nUHJlZnMnIGNhcCBpbnN0ZWFkLCB3aXRoIGEgJ3BlcmZvcm1hbmNlJyBrZXkgc2V0IHRvICdBTEwnYCk7XG4gICAgY29uc3QgbmV3UHJlZiA9IHtwZXJmb3JtYW5jZTogJ0FMTCd9O1xuICAgIC8vIGRvbid0IG92ZXJ3cml0ZSBvdGhlciBsb2dnaW5nIHByZWZzIHRoYXQgaGF2ZSBiZWVuIHNlbnQgaW4gaWYgdGhleSBleGlzdFxuICAgIGNhcHMubG9nZ2luZ1ByZWZzID0gY2Fwcy5sb2dnaW5nUHJlZnMgP1xuICAgICAgT2JqZWN0LmFzc2lnbih7fSwgY2Fwcy5sb2dnaW5nUHJlZnMsIG5ld1ByZWYpIDpcbiAgICAgIG5ld1ByZWY7XG4gIH1cblxuICBpZiAob3B0cy5jaHJvbWVPcHRpb25zPy5Bcmd1bWVudHMpIHtcbiAgICAvLyBtZXJnZSBgQXJndW1lbnRzYCBhbmQgYGFyZ3NgXG4gICAgb3B0cy5jaHJvbWVPcHRpb25zLmFyZ3MgPSBbLi4uKG9wdHMuY2hyb21lT3B0aW9ucy5hcmdzIHx8IFtdKSwgLi4ub3B0cy5jaHJvbWVPcHRpb25zLkFyZ3VtZW50c107XG4gICAgZGVsZXRlIG9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHM7XG4gIH1cbiAgZm9yIChjb25zdCBbb3B0LCB2YWxdIG9mIF8udG9QYWlycyhvcHRzLmNocm9tZU9wdGlvbnMpKSB7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoY2Fwcy5jaHJvbWVPcHRpb25zW29wdF0pKSB7XG4gICAgICBjYXBzLmNocm9tZU9wdGlvbnNbb3B0XSA9IHZhbDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmluZm8oYFRoZSAnJHtvcHR9JyBjaHJvbWVPcHRpb24gKCR7Y2Fwcy5jaHJvbWVPcHRpb25zW29wdF19KSBgICtcbiAgICAgICAgYHdvbid0IGJlIGFwcGxpZWQgdG8gQ2hyb21lZHJpdmVyIGNhcGFiaWxpdGllcyBiZWNhdXNlIGl0IGhhcyBiZWVuIGFscmVhZHkgYXNzaWduZWQgYmVmb3JlYCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBjYXBzO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgaGVscGVycztcbmV4cG9ydCB7IGhlbHBlcnMsIE5BVElWRV9XSU4sIFdFQlZJRVdfV0lOLCBXRUJWSUVXX0JBU0UsIENIUk9NSVVNX1dJTiB9O1xuIl0sImZpbGUiOiJsaWIvd2Vidmlldy1oZWxwZXJzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
